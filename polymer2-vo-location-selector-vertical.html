<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../geo-location/geo-location.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../vo-search-location/vo-search-location.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">
<link rel="import" href="../iron-media-query/iron-media-query.html">

<link rel="import" href="../vaadin-lumo-styles/color.html">

<link rel="import" href="polymer2-vo-location-selector-icons.html">


<dom-module id="vo-location-selector-vertical">
  <template>
    <style include="lumo-color">
      :host {
        display: block;
        width: 100%;
      }

      .bottombar {
        width: 48px;
        background-color: var(--lumo-base-color);
        color: var(--lumo-contrast);
        border-radius: 3px;
        position: absolute;
        right: 16px;
      }


      paper-button.toolButton {
        min-width: 48px;
        padding: 10px;
        margin: 0;

      }

      #buttonbar {
        display: grid;
        grid-template-columns: repeat(1, 48px);
      }

      #collapseSearch {
        max-width: 650px;
        width: 100%;
        background:  var(--lumo-base-color);
        position: fixed;
        bottom: 0px;
        right: 0px;
      }

      vo-search-location {
        margin-left: 40px;
        margin-top: -68px;
      }

      vo-search-location iron-icon.clear-button {
        --iron-icon-width: 20px;
        --iron-icon-height: 20px;
      }

      paper-button.collapseSearchButton {
        min-width: 48px;
        padding-right: 8px;
        margin: 0;
        height: 68px;
      }


    </style>

    <!--Button bar-->
    <iron-collapse id="collapseButtonbar" opened="{{opened}}" class="bottombar" theme$="[[buttonBarTheme]]">
      <geo-location on-position-changed="handleGeoLocationChange"
                    on-geo-error="handleGeoLocationError"
                    idle="[[!useGeolocation]]">

      </geo-location>

      <div id="buttonbar">

        <paper-button class="toolButton"  id="searchButton" active="{{useCrab}}" on-click="handleSearchClicked">
          <iron-icon icon="vo-location-icons:search"></iron-icon>

        </paper-button>

        <paper-button class="toolButton" active="{{useGeolocation}}" on-click="handleAutoLocationClicked">
          <iron-icon icon="vo-location-icons:my-location"></iron-icon>

        </paper-button>

        <paper-button class="toolButton" active="{{useMap}}" on-click="handleChooseLocationClicked">
          <iron-icon icon="vo-location-icons:pin-drop"></iron-icon>

        </paper-button>
      </div>
    </iron-collapse>


    <!--search bar-->
   <iron-collapse id="collapseSearch" opened="{{searchActive}}">
     <paper-button  class='collapseSearchButton' id="collapseSearchButton"  on-click="closeSearchBar">
       <iron-icon icon="vo-location-icons:arrow-back"></iron-icon>
     </paper-button>
     <vo-search-location on-search-location-changed="handleSearchLocationChange"
                         allow-custom-value="true"
                         focus="{{searchActive}}">
     </vo-search-location>
  </iron-collapse>

  </template>

  <script>
    class VoMapLocationSelectorVertical extends Polymer.Element {
      static get is() {
        return 'vo-location-selector-vertical';
      }

      static get properties() {
        return {
          useGeolocation: {
            type: Boolean,
            value: false
          },
          useMap: {
            type: Boolean,
            value: false
          },
          useCrab: {
            type: Boolean,
            value: false
          },
          buttonBarTheme: {
            type: String,
            value: "dark"
          },
          opened : {
            type: Boolean,
            value: false
          }
        };
      }


      //-----------------------------------------------------------------------------------------------//
      //-- Handle Buttons Clicks  ------------ --------------------------------------------------------//
      //-----------------------------------------------------------------------------------------------//
      /**
       * Search Button clicked event.
       * @param event
       * @param object
       */
      handleSearchClicked() {
        this.$.collapseSearch.opened = true;
        this.$.collapseButtonbar.opened = false;
        this.useCrab = true;
        this.useGeolocation = false;
        this.useMap = false;

      }


      /**
       * Geolocation Button clicked event.
       * @param event
       * @param object
       */
      handleAutoLocationClicked() {
        this.useMap = false;
        this.useGeolocation = true;
        this.disableSearch();

      }

      /**
       * Place Marker Button clicked event.
       * @param event
       * @param object
       */
      handleChooseLocationClicked() {
        this.useGeolocation = false;
        this.useMap = true;
        this.disableSearch();
        this.fireLocationSelectLocation();
      }

      //-----------------------------------------------------------------------------------------------//
      //-- Handle events from child components --------------------------------------------------------//
      //-----------------------------------------------------------------------------------------------//

      /**
       * Handle Crab Search event: location change.
       *
       */
      handleSearchLocationChange(event) {
        //console.log("location:" + event.detail.latitude + " - " + event.detail.longitude);
        this.disableSearch();
        this.fireLocationUpdated("crab-search", event.detail.latitude, event.detail.longitude, 17);
      }


      /**
       * Handle Geolocation event: location change.
       * */
      handleGeoLocationChange(event, object) {
        if (object.value && this.useGeolocation) {
          //console.log("Navigating to geolocator point");
          //console.log("location:" + object.value.coords.latitude + " - " + object.value.coords.longitude);
          this.fireLocationUpdated("geolocation-api", object.value.coords.latitude, object.value.coords.longitude, 17);
        }
      }


      handleGeoLocationError(e) {
        this.dispatchEvent(new CustomEvent('geo-error', {
          detail: e.detail
        }));
      }

      //-----------------------------------------------------------------------------------------------//
      //-- Fire events --------------------------------------------------------------------------------//
      //-----------------------------------------------------------------------------------------------//

      fireLocationUpdated(source, lat, long, zoom) {
        this.dispatchEvent(new CustomEvent('location-updated', {
          detail: {
            source: source,
            latitude: lat,
            longitude: long,
            zoom: zoom
          }
        }));
      }

      fireLocationSelectLocation() {
        this.dispatchEvent(new CustomEvent('start-location-selection', {
          detail: {
          }
        }));
      }

      //-----------------------------------------------------------------------------------------------//
      //-- Private ------------------------------------------------------------------------------------//
      //-----------------------------------------------------------------------------------------------//

      closeSearchBar() {
          //todo clear address if it was filled when the search bar is shown
          this.$.collapseSearch.opened = false;
          this.$.collapseButtonbar.opened = true;
      }

      disableSearch(){
        this.useCrab = false;
        this.$.collapseSearch.opened = false;
        this.$.collapseButtonbar.opened = true;

      }
    }

    window.customElements.define(VoMapLocationSelectorVertical.is, VoMapLocationSelectorVertical);
  </script>
</dom-module>
